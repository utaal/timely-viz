<head>
  <script src="https://vega.github.io/vega/vega.js"></script>
</head>
<body>

  <div id="container">
    
    <button id="back">back</button>

    <div id="view"></div>
    <div id="view-rhs"></div>
  </div>

  <style>
    #back{
  padding: 10px 25px;
  font-size: 24px;
  text-align: center;
  outline: none;
  color: #fff;
  background-color: #42c2f4;
  border: none;
  border-radius: 10px;
  box-shadow: 0 4px #999;
  position:relative;
  }

    #back:hover {
      background-color: #4192f4
    }

    #back:active {
      background-color: #3e8e41;
 
    }
    #view{
      float:left;
      padding-left:10px;
    }
    #view-rhs{
      float:right;
      padding-right: 10px;
  }
 

  </style>
<script type="text/javascript">
let my_spec = {
  "$schema": "https://vega.github.io/schema/vega/v4.json",
  "width": 600,
  "height": 1000,
  "padding": 80,
  "autosize": "fit",

  "data": [
    {
      "name": "tree",
      "values":[]
    },
    {
      "name": "sunburst",
       "source": "tree",
      "transform": [

        {
          "type": "stratify",
          "key": "addr",
          "parentKey": "parent"
        },
        {
          "type": "partition",
          "field": "elapsed_ns",
          "sort": {"field": "value"},
          "size": [{"signal": " 2 * PI"}, {"signal": "width / 2.5"}],
          "as": ["a0", "r0", "a1", "r1", "depth", "chidlren"]
        }
      ]
    },
    
    {
     "name": "table",
     "source": "tree",
     "transform": [
        {
          "type": "filter",
          "expr": "datum.parent == filterlist"
        }
     ]
    }
  ],
   "signals": [
        {
          "name": "filterlist",
          "value": "[0,0]",
           "on": [{"events": "click", "update": "invert('yscale', y())"}]
   
        }
      ],

  "scales": [
    {
      "name": "color",
      "type": "ordinal",
      "range": {"scheme": "tableau20"}
    },   
    {
        "name": "yscale",
        "type": "band",
        "domain": {"data": "tree", "field": "addr"},
        "range": [950,400],
        "padding": 0.05,
        "round": true,
        "clamp": true
      },
      {
        "name": "xscale",
        "domain": {"data": "tree", "field": "elapsed_ns"},
        "nice": true,
        "range": "width"
      }
  ],
   "axes": [
      { "orient": "left", 
        "scale": "yscale",
        "titlePadding": 15,
        "title": "addr",
        "titleFontSize": 16,
        "labelFontSize": 14
      },
      {
        "orient": "bottom",
        "scale": "xscale",
        "labelOverlap": "parity",
        "title": "elapsed_ns",
        "titleFontSize": 16,
        "labelFontSize": 14
      }
      ],
  "marks": [
    {
      "type": "arc",
      "from": {"data": "sunburst"},
      "encode": {
        "enter": {
          "x": {"signal": "width / 4"},
          "y": {"signal": "height / 6"},
          "fill": {"scale": "color", "field": "depth"},
          "tooltip": {"signal": "datum.addr + (datum.elapsed_ns? ', ' + datum.elapsed_ns + ' ns' : '')"}
        },
        "update": {
          "x": {"signal": "width / 4"},
          "y": {"signal": "height / 6"},
          "startAngle": {"field": "a0"},
          "endAngle": {"field": "a1"},
          "innerRadius": {"field": "r0"},
          "outerRadius": {"field": "r1"},
          "stroke": {"value": "white"},
          "strokeWidth": {"value": 0.5},
          "zindex": {"value": 0},
          "tooltip": {"signal": "'name: ' + datum.name  + '' + ' addr: ' + datum.addr + ' time: ' + datum.elapsed_ns + ' ns'"}
        },
        "hover": {
          "stroke": {"value": "red"},
          "strokeWidth": {"value": 2},
          "zindex": {"value": 1}
        }
      }
    },    
    {
        "type": "rect",
        "from": {"data":"table"},
        "encode": {
          "enter": {
            "y": {"scale": "yscale", "field": "addr"},
            "height": {"scale": "yscale", "band": 1},
            "x": {"scale": "xscale", "field": "elapsed_ns"},
            "x2": {"scale": "xscale", "value": 0}
          },
          "update": {
            "fill": {"value": "steelblue"},
            "x": {"scale": "xscale", "field": "elapsed_ns"},
            "height": {"scale": "yscale", "band": 1},
            "y": {"scale": "yscale", "field": "addr"},
            "x2": {"scale": "xscale", "value": 0}
          },
          "hover": {
            "fill": {"value": "#4192f4"}
          }
        }
      },
      {
        "type": "text",
        "encode": {
          "enter": {
            "fill": {"value": "black"},
            "fontSize": {"value": 20},
            "align": {"value": "right"},
            "x":{"value": 180},
            "y":{"value": 400}
            
          },
          "update": {
            "text": {"signal": "'current filter: ' + filterlist"}

          }
        }
      }
  ]
};

    const back_button = document.getElementById('back');  

    var view = new
    vega.View(vega.parse(my_spec))
    .logLevel(vega.Warn)
    .renderer('canvas')  // set renderer (canvas or svg)
    .initialize('#view') // initialize view within parent DOM container
    .hover()             // enable hover encode set processing
    .run();

     view.insert('tree', {"addr": "[0,0]", "parent": null, "name": "Dataflow", "elapsed_ns": 0}).run();
     
          

    let map_operates = new Map();
    let map_channels = new Map();
    let map_schedule = new Map();
    let map_messages = new Map();
    


    let websocket = new WebSocket("ws://localhost:9000/ws/");
    websocket.addEventListener('message', (ev) => {

      let updates = JSON.parse(ev.data).updates;

      let changeset = vega.changeset();
      let changeset_msgs = vega.changeset();

      back_button.onclick = () => {
        let cur = view.signal('filterlist');
        view.signal('filterlist', cur.substring(0, cur.lastIndexOf(',')) + "]");
      };

            
      let map_temp_ops = new Map();
      let map_temp_chs = new Map();
      let map_temp_sch = new Map();
      let map_temp_msg = new Map();   
      
      for (let update of updates) {
       
        if(!!update.event.Operate){
          if(!map_temp_ops.has(update.event.Operate.id)){
            map_temp_ops.set(update.event.Operate.id, []);
          }        
          map_temp_ops.get(update.event.Operate.id).push(update);
        }

        else if(!!update.event.Channel){
 
          if(!map_temp_chs.has(update.event.Channel.id)){
            map_temp_chs.set(update.event.Channel.id, []);
          }        
          map_temp_chs.get(update.event.Channel.id).push(update);
        
        }
        else if(!!update.event.Schedule){

          if(!map_temp_sch.has(update.event.Schedule.operate_id)){
            map_temp_sch.set(update.event.Schedule.operate_id, []);
          }        
          map_temp_sch.get(update.event.Schedule.operate_id).push(update);
    
        }

        else if (!!update.event.Messages){

          if(!map_temp_msg.has(update.event.Messages.channel_id)){
            map_temp_msg.set(update.event.Messages.channel_id, []);
          }        
          map_temp_msg.get(update.event.Messages.channel_id).push(update);
        
        }
      }

      for(let [id,list] of map_temp_ops){
         if(list.length == 1){
           
             if(list[0].delta == 1){
               map_operates.set(id, list[0].event.Operate);

              }else {
                map_operates.delete(id);
              } 
         }else if(list.length == 2){
              if(list[0].delta == 1){
                map_operates.set(id, list[0].event.Channel);
             }else {
                map_operates.delete(id);
             }

         }else {
           console.error("More than 2 updates");
         }
      }


      for(let [id,list] of map_temp_chs){
         if(list.length == 1){
           
             if(list[0].delta == 1){
               map_channels.set(id, list[0].event.Channel);

              }else {
                map_channels.delete(id);
              }
           
         }else if(list.length == 2){
             if(list[0].delta == 1){
               map_channels.set(id, list[0].event.Channel)
             }else {
                map_channels.set(id, list[1].event.Channel)
             }
         }else {
           console.error("More than 2 updates");
         }
      }

      for(let [id,list] of map_temp_sch){

         if(list.length == 1){

               let o = map_operates.get(id);
               let obj = {"addr":  '[' + o.addr.toString() + ']', 
                          "parent":  '[' + o.addr.toString().substring(0, o.addr.toString().lastIndexOf(',')) + ']',
                          "elapsed_ns": list[0].event.Schedule.elapsed_ns,
                          "name": o.name,
                          "id": list[0].event.Schedule.operate_id
                           };
               
              console.log(o);
             if(list[0].delta == 1){
              
               changeset.insert(obj);
               map_schedule.set(id, list[0].event.Schedule);     
                 
              }else {
                map_schedule.delete(id);
                changeset.remove((x) => x.id == list[0].event.Schedule.operate_id);
              }
         }else if(list.length == 2){
             if(list[0].delta == 1){
               
               changeset.modify((x) => x.id == list[0].event.Schedule.operate_id, "elapsed_ns", list[0].event.Schedule.elapsed_ns);
               map_schedule.set(id, list[0].event.Schedule);

             }else {
                
                changeset.modify((x) => x.id == list[1].event.Schedule.operate_id, "elapsed_ns", list[1].event.Schedule.elapsed_ns);
                map_schedule.set(id, list[1].event.Schedule);
             }
         }else {
          console.error("More than 2 updates");
         }
      }
    
      for(let [id,list] of map_temp_msg){
         if(list.length == 1){
             if(list[0].delta == 1){
               map_messages.set(id, list[0].event.Messages);
              }else {
                map_messages.delete(id);
              }
         }else if(list.length == 2){
             if(list[0].delta == 1){
               map_messages.set(id, list[0].event.Messages)
             }else {
                map_messages.set(id, list[1].event.Messages)
             }
         }else {
          console.error("More than 2 updates");
         }
      }


          /*

                      let obj = {"id": update.event.Channel.id,
                     "from_addr": update.event.Channel.from_addr.toString(),
                     "from_port": update.event.Channel.from_port,
                     "to_addr": update.event.Channel.to_addr.toString(),
                     "to_port": update.event.Channel.to_port,
                     "delta": update.delta
                    };

                    };
            */
      
      

     view.change('tree', changeset).run();
      
    });

  </script>
</body>

